<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Showdown Manager</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bracket-bg: #333;
    --bracket-line: #666;
    --bracket-text: #eee;
    --card-bg: #444;
    --card-border: #888;
    --winner-color: #ffcb05;
    --loser-color: #999;
  }

  body {
    font-family: 'Poppins', sans-serif;
    margin: 0; padding: 0;
    background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
    min-height: 100vh;
  }

  .container {
    max-width: 1100px;
    margin: 20px auto;
    background: #fefefe;
    padding: 15px;
    border-radius: 20px;
    box-shadow: 0 15px 30px rgba(0,0,0,0.2);
  }

  h1, h2 { text-align: center; color: #333; font-family: 'Press Start 2P', cursive; }
  input, button, textarea { display: block; width: 100%; margin: 10px 0; padding: 12px; border-radius: 12px; border: 1px solid #ccc; font-size: 1rem; box-sizing: border-box; }
  button { background-color: #ffcb05; color: #3b4cca; font-weight: bold; border: 2px solid #3b4cca; cursor: pointer; transition: all 0.3s ease; }
  button:hover { background-color: #f5b700; transform: scale(1.05); }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  .hidden { display: none !important; }

  /* Trainer Card */
  .trainer-card {
    background: radial-gradient(circle at 30% 30%, #f5f5f5 0%, #fff8e1 100%);
    border: 4px solid #3b4cca;
    border-radius: 30px;
    padding: 20px;
    max-width: 400px;
    margin: 20px auto;
    text-align: center;
    box-shadow: 0 12px 25px rgba(0,0,0,0.4);
    position: relative;
    overflow: hidden;
  }

  .trainer-header {
    display: flex; flex-direction: column; align-items: center; gap: 12px;
  }

  .trainer-card img {
    border-radius: 50%;
    width: 120px; height: 120px;
    border: 3px solid #ff1f1f;
    background: #fff;
  }

  .trainer-card h3 {
    color: #3b4cca;
    margin: 0;
    font-family: 'Press Start 2P', cursive;
    font-size: 1rem;
  }
  .trainer-card p {
    margin: 5px 0;
    font-weight: bold;
    color: #333;
  }
  .progress-bar-container {
    width: 100%;
    background-color: #ddd;
    border-radius: 10px;
    margin: 10px 0;
    position: relative;
    height: 20px;
  }
  .progress-bar {
    height: 20px;
    background-color: #4CAF50;
    border-radius: 10px;
    text-align: right;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
    line-height: 20px;
    transition: width 0.5s ease-in-out;
    padding-right: 5px;
    white-space: nowrap;
    overflow: hidden;
  }
  .progress-text {
    position: absolute;
    width: 100%;
    text-align: center;
    font-size: 0.8rem;
    line-height: 20px;
    color: #333;
  }

  .card-pokemon {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
  }

  .pokemon-box {
    position: relative;
    display: inline-block;
  }
  .pokemon-box img {
    width: 60px; height: 60px;
    background: #f5f5f5;
    border: 2px solid #3b4cca;
    border-radius: 12px;
    padding: 3px;
  }
  .remove-btn {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #ff1f1f;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    line-height: 15px;
    text-align: center;
    transition: transform 0.2s, background 0.2s;
  }
  .remove-btn:hover {
    background: #d62828;
    transform: scale(1.1);
  }

  #card-championships { margin-top: 15px; font-weight: bold; color: #d62828; }

  #suggestions { border: 1px solid #ccc; max-height: 150px; overflow-y: auto; cursor: pointer; background: #fff; border-radius: 8px; position: absolute; z-index: 1000; width: calc(100% - 26px); }
  #suggestions div:hover { background:#eee; }

  /* Novo estilo de Chaveamento */
  .bracket-container {
    background: var(--bracket-bg);
    color: var(--bracket-text);
    padding: 20px;
    border-radius: 15px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    white-space: nowrap;
  }
  .bracket-heading {
    text-align: center;
    font-size: 1.5rem;
    font-family: 'Press Start 2P', cursive;
    margin-bottom: 20px;
  }
  .bracket-rounds {
    display: inline-flex;
    gap: 30px;
    justify-content: center;
    align-items: center;
    padding: 20px 0;
  }
  .bracket-round {
    display: flex;
    flex-direction: column;
    gap: 20px;
    position: relative;
    vertical-align: top;
    white-space: normal;
  }
  .round-heading {
    text-align: center;
    font-weight: bold;
    margin-bottom: 10px;
  }
  .bracket-matchup {
    position: relative;
    padding: 10px;
    border-radius: 8px;
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    min-width: 150px;
    text-align: left;
  }
  .bracket-player {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    padding: 3px 0;
  }
  .bracket-player.is-winner {
    font-weight: bold;
    color: var(--winner-color);
  }
  .bracket-player.is-loser {
    color: var(--loser-color);
  }
  .bracket-line {
    position: absolute;
    border-right: 2px solid var(--bracket-line);
    border-top: 2px solid var(--bracket-line);
    content: '';
  }
  .bracket-line.top-line {
    right: -15px;
    top: calc(50% - 1px);
    height: 15px;
    width: 15px;
  }
  .bracket-line.bottom-line {
    right: -15px;
    top: calc(50% - 1px);
    height: 15px;
    width: 15px;
    border-top: none;
    border-bottom: 2px solid var(--bracket-line);
  }
  .player-btn {
    cursor: pointer;
    font-size: 0.8rem;
    color: #ffcb05;
    background: none;
    border: none;
    padding: 5px;
    border-radius: 5px;
    transition: all 0.2s;
  }
  .player-btn:hover {
    background: rgba(255, 203, 5, 0.2);
  }
  
  /* Estilo da lista de torneios */
  .champ-list-card {
    padding: 15px;
    background: #f0f0f0;
    margin-bottom: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  .champ-list-card:hover {
    background: #e0e0e0;
    transform: translateY(-2px);
  }
  .champ-list-card h4 {
    margin: 0;
    color: #3b4cca;
  }
  .champ-list-card p {
    margin: 5px 0 0;
    font-size: 0.9rem;
    color: #555;
  }
  .champ-list-card .status {
    font-size: 0.8rem;
    font-weight: bold;
    color: #fff;
    padding: 2px 8px;
    border-radius: 10px;
    text-transform: uppercase;
  }
  .status.open { background-color: #28a745; }
  .status.in-progress { background-color: #ffc107; }
  .status.finished { background-color: #dc3545; }


  /* Tabbed Navigation */
  .tab-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
  }
  .tab-buttons button {
    width: auto;
    flex: 1;
    font-size: 0.8rem;
    padding: 10px 15px;
    background-color: #e9ecef;
    color: #495057;
    border: 1px solid #dee2e6;
  }
  .tab-buttons button.active {
    background-color: #ffcb05;
    color: #3b4cca;
    border-color: #3b4cca;
  }
  #ranking-list li, .search-result-item {
    background: #f8f9fa;
    padding: 10px;
    margin-bottom: 5px;
    border-radius: 5px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
  }
  #ranking-list li:hover, .search-result-item:hover {
    background: #e0e0e0;
    transform: translateY(-2px);
  }

  /* Novo layout de perfil */
  .profile-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  .profile-section-card {
    background: #f8f8f8;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    flex: 1 1 300px;
  }
  
  /* Modal de Replay */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  .modal-content {
    background-color: #fff;
    padding: 30px;
    border-radius: 15px;
    max-width: 90%;
    width: 400px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    text-align: center;
  }
  .modal-content h3 {
    margin-top: 0;
    font-family: 'Press Start 2P', cursive;
  }
  .modal-buttons {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }
  .modal-buttons button {
    flex: 1;
  }
  
  /* Layout de busca de usu√°rio */
  #user-search-container {
    margin-bottom: 20px;
  }
  #search-results-list {
    margin-top: 15px;
  }
  .search-result-item {
    background: #f8f9fa;
    padding: 10px;
    margin-bottom: 5px;
    border-radius: 5px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    cursor: pointer;
  }
  #user-profile-details-view .trainer-card {
    margin-top: 0;
  }

  /* Nomes dos jogadores no chaveamento que s√£o links */
  .player-name-link {
    cursor: pointer;
    transition: color 0.2s;
  }
  .player-name-link:hover {
    color: #ffcb05;
    text-decoration: underline;
  }

  .badge-list {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
  }
  .badge-item {
    text-align: center;
    font-weight: bold;
    background: #e9ecef;
    padding: 5px 10px;
    border-radius: 8px;
  }

  .social-links a {
    display: block;
    margin-top: 5px;
    color: #3b4cca;
    text-decoration: none;
    font-weight: bold;
    transition: color 0.2s;
  }
  .social-links a:hover {
    color: #ffcb05;
  }
  
  .champ-list-card.gym-tournament {
    border: 3px solid #ffcb05;
    box-shadow: 0 4px 8px rgba(255, 203, 5, 0.4);
    background: #fff8e1;
  }

  #all-championships-list-gym-active h4,
  #all-championships-list-gym-finished h4 {
    color: #c39a00;
  }

  .pokemon-search-container {
    position: relative;
    display: block;
  }
  .pokemon-search-container input {
    margin-bottom: 0;
  }
  .pokemon-search-container #suggestions {
    position: absolute;
    width: calc(100% - 2px);
    top: 100%;
    left: 0;
    z-index: 10;
    border-top: none;
  }
  
  .profile-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
  }


  @media (max-width: 600px) {
    .container {
      padding: 10px;
      margin: 10px auto;
    }
    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.2rem; }
    .tab-buttons { flex-wrap: wrap; }
    .tab-buttons button { font-size: 0.7rem; padding: 8px; }
    .bracket-container { white-space: normal; }
    .bracket-rounds { display: block; }
    .bracket-round { margin-bottom: 20px; }
  }
</style>
</head>
<body>
<div class="container">

  <div id="login-screen">
    <h1>Showdown Manager</h1>
    <h2>Login</h2>
    <input type="text" id="login-username" placeholder="Usu√°rio">
    <input type="password" id="login-password" placeholder="Senha">
    <button onclick="login()">Entrar</button>
    <h2>Cadastro</h2>
    <input type="text" id="signup-username" placeholder="Novo usu√°rio">
    <input type="password" id="signup-password" placeholder="Nova senha">
    <button onclick="signup()">Cadastrar</button>
  </div>

  <div id="user-screen" class="hidden">
    <h1>Bem-vindo, <span id="user-display"></span>!</h1>
    <button onclick="logout()">Logout</button>

    <div class="tab-buttons">
      <button onclick="showTab('profile')">Meu Perfil</button>
      <button onclick="showTab('my-tournaments')">Meus Torneios</button>
      <button onclick="showTab('all-tournaments')">Torneios Ativos</button>
      <button onclick="showTab('leaderboard')">Ranking Global</button>
      <button id="admin-tab-btn" class="hidden" onclick="showTab('admin-panel')">Painel Admin</button>
    </div>
    
    <div id="profile-tab" class="tab-content hidden">
      <div class="profile-layout">
        
        <div class="profile-section-card">
          <h2>Meu Perfil</h2>
          <div id="profile-display-section">
            <div class="trainer-card" id="trainer-card">
              <div class="trainer-header">
                <img id="card-image" src="https://via.placeholder.com/120" alt="Treinador">
                <h3 id="card-name"></h3>
                <p>N√≠vel: <span id="card-level"></span></p>
                <div class="progress-bar-container">
                  <div class="progress-bar" id="level-progress-bar"></div>
                </div>
                <p>Pontos: <span id="card-points"></span></p>
                <div id="profile-display-socials"></div>
              </div>
            </div>
            <div class="profile-buttons">
              <button onclick="toggleEditProfile(true)">Editar Perfil</button>
            </div>
          </div>
          
          <div id="profile-edit-section" class="hidden">
            <input type="text" id="player-name" placeholder="Nome do treinador">
            <input type="text" id="player-image" placeholder="URL da imagem do treinador">
            <textarea id="bio-textarea" placeholder="Sua biografia" rows="4"></textarea>
            <input type="text" id="twitter-input" placeholder="Link do Twitter">
            <input type="text" id="discord-input" placeholder="ID do Discord">
            <div class="profile-buttons">
              <button onclick="saveProfile()">Salvar Perfil</button>
              <button onclick="toggleEditProfile(false)">Cancelar</button>
            </div>
          </div>
        </div>

        <div class="profile-section-card">
          <h2>Meus Pok√©mon Favoritos</h2>
          <label>Adicionar Pok√©mon:</label>
          <div class="pokemon-search-container">
            <input type="text" id="pokemon-search" placeholder="Pesquise Pok√©mon">
            <div id="suggestions"></div>
          </div>
          <div class="card-pokemon" id="card-pokemons-card"></div>
        </div>

        <div class="profile-section-card">
          <h2>Ins√≠gnias de Gin√°sio</h2>
          <div class="badge-list" id="my-badges-list"></div>
        </div>

      </div>
    </div>

    <div id="my-tournaments-tab" class="tab-content hidden">
      <h2>Criar Campeonato</h2>
      <input type="text" id="championship-name" placeholder="Nome do campeonato">
      <textarea id="championship-rules" placeholder="Regras do campeonato"></textarea>
      <input type="date" id="championship-date">
      <input type="number" id="championship-max" placeholder="M√°x. participantes">
      <button onclick="createChampionship()">Criar Campeonato</button>
      <h3>Meus Torneios</h3>
      <div id="my-championships-list-active"></div>
      <h3>Torneios Finalizados</h3>
      <div id="my-championships-list-finished"></div>
    </div>
    
    <div id="all-tournaments-tab" class="tab-content hidden">
      <h3>Torneios de Gin√°sio</h3>
      <div id="all-championships-list-gym-active"></div>
      <h3>Outros Torneios Ativos</h3>
      <div id="all-championships-list-active"></div>
      <hr>
      <h3>Torneios Finalizados</h3>
      <div id="all-championships-list-gym-finished"></div>
      <div id="all-championships-list-finished"></div>
    </div>

    <div id="leaderboard-tab" class="tab-content hidden">
      <h3>Ranking Global</h3>
      <ol id="ranking-list"></ol>
      <div id="user-search-container">
        <h3>Buscar Usu√°rio</h3>
        <input type="text" id="user-search-input" placeholder="Pesquisar por nome ou usu√°rio">
        <div id="search-results-list"></div>
      </div>
    </div>

    <div id="admin-panel-tab" class="tab-content hidden">
      <h2>Painel de Administra√ß√£o</h2>
      <h3>Gerenciar Usu√°rios</h3>
      <div id="user-list-admin"></div>
    </div>

    <div id="championship-details-view" class="hidden">
      <button onclick="goBackToList()">Voltar para a lista</button>
      <div class="champ-card">
        <h3 id="champ-details-name"></h3>
        <p><strong>Status:</strong> <span id="champ-details-status"></span></p>
        <p><strong>Criador:</strong> <span id="champ-details-owner"></span></p>
        <p><strong>Data:</strong> <span id="champ-details-date"></span></p>
        <p><strong>Regras:</strong> <span id="champ-details-rules"></span></p>
        <p><strong>Jogadores:</strong> <span id="champ-details-players"></span> (<span id="champ-details-count"></span>/<span id="champ-details-max"></span>)</p>
        <button id="join-btn" onclick="">Entrar</button>
        <button id="bracket-btn" onclick="">Sortear Chaveamento</button>
        <button id="delete-btn" onclick="">Excluir</button>
      </div>
      <div id="championship-bracket-container"></div>
    </div>

    <div id="user-profile-details-view" class="hidden">
        <button onclick="goBackFromProfile()">Voltar</button>
        <div class="profile-layout">
            <div class="profile-section-card">
                <h2>Perfil do Jogador</h2>
                <div class="trainer-card">
                    <div class="trainer-header">
                        <img id="other-user-card-image" src="https://via.placeholder.com/120" alt="Treinador">
                        <h3 id="other-user-card-name"></h3>
                        <p>N√≠vel: <span id="other-user-card-level"></span></p>
                        <p>Pontos: <span id="other-user-card-points"></span></p>
                        <div class="social-links" id="other-user-socials"></div>
                    </div>
                </div>
                <p><strong>Biografia:</strong> <span id="other-user-bio"></span></p>
            </div>
            <div class="profile-section-card">
                <h2>Pok√©mon Favoritos</h2>
                <div class="card-pokemon" id="other-user-card-pokemons"></div>
            </div>
            <div class="profile-section-card">
                <h2>Ins√≠gnias de Gin√°sio</h2>
                <div class="badge-list" id="other-badges-list"></div>
            </div>
        </div>
    </div>
  </div>
</div>

<div id="winner-modal" class="modal-overlay hidden">
  <div class="modal-content">
    <h3 id="modal-title"></h3>
    <input type="url" id="replay-link" placeholder="Link do Replay (opcional)">
    <div class="modal-buttons">
      <button onclick="confirmWinner()">Confirmar Vit√≥ria</button>
      <button onclick="hideWinnerModal()">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
  // Firebase SDKs
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, updateDoc, arrayUnion, arrayRemove, addDoc, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

  // Configura√ß√£o do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyASjpqLbD2a5zFdsXLAErFa5324ecJsIYY",
    authDomain: "showdown-camp.firebaseapp.com",
    projectId: "showdown-camp",
    storageBucket: "showdown-camp.appspot.com",
    messagingSenderId: "340772186713",
    appId: "1:340772186713:web:e23ba55d58ed95ed561f48"
  };

  // Inicialize o Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Vari√°veis globais
  let allPokemons = [];
  const LEVEL_THRESHOLDS = {
    1: 0, 2: 100, 3: 250, 4: 500, 5: 1000,
    6: 2000, 7: 4000, 8: 8000, 9: 16000, 10: 32000
  };

  const GYM_BADGES = [
    'Rocha', 'Cascata', 'Trov√£o', 'Arco-√çris', 'Alma', 'Marsh', 'Vulc√£o', 'Terra'
  ];

  let currentWinnerChampId, currentWinnerRound, currentWinnerBattle, currentWinnerUid;
  let previousTab = 'profile';
  let currentUserId = null;
  let allUsersData = {};

  async function loadAllPokemons() {
    try {
        const response = await fetch('https://pokeapi.co/api/v2/pokemon?limit=2000');
        const data = await response.json();
        allPokemons = data.results.map(p => capitalize(p.name));
    } catch (error) {
        console.error("Erro ao carregar lista de Pok√©mon:", error);
    }
  }
  
  function capitalize(str){ return str.charAt(0).toUpperCase()+str.slice(1); }

  const pokemonSearchInput = document.getElementById('pokemon-search');
  const pokemonSuggestionsDiv = document.getElementById('suggestions');

  pokemonSearchInput.addEventListener('input', function(){
    const value = this.value.toLowerCase();
    pokemonSuggestionsDiv.innerHTML='';
    if(!value) return;
    const matches = allPokemons.filter(p => p.toLowerCase().startsWith(value)).slice(0,10);
    matches.forEach(p=>{
      const div = document.createElement('div');
      div.innerText = p;
      div.onclick = ()=>addPokemon(p);
      pokemonSuggestionsDiv.appendChild(div);
    });
  });

  async function addPokemon(name){
    if (!currentUserId) return;
    pokemonSuggestionsDiv.innerHTML='';
    pokemonSearchInput.value='';
    
    const userDocRef = doc(db, 'users', currentUserId);
    const user = allUsersData[currentUserId];
    
    if(user && !user.profile.pokemons.includes(name)){
        await updateDoc(userDocRef, {
            "profile.pokemons": arrayUnion(name)
        });
        await loadProfile();
    }
  }

  async function removePokemon(name){
    if (!currentUserId) return;
    const userDocRef = doc(db, 'users', currentUserId);
    await updateDoc(userDocRef, {
        "profile.pokemons": arrayRemove(name)
    });
    await loadProfile();
  }

  async function signup(){
    const username = document.getElementById('signup-username').value.trim();
    const password = document.getElementById('signup-password').value.trim();
    const email = username + "@showdown.com"; 
    if(!username||!password){alert("Preencha todos os campos!"); return;}
    
    const q = query(collection(db, "users"), where("username", "==", username));
    const querySnapshot = await getDocs(q);
    if (!querySnapshot.empty) {
        alert("Usu√°rio j√° existe!");
        return;
    }

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        const isAdmin = username === 'frogar';

        await setDoc(doc(db, "users", user.uid), {
            username: username,
            profile:{ name: username, trainerImage:'', pokemons:[], bio: '', twitter: '', discord: '' },
            points: 0,
            level: 1,
            isAdmin: isAdmin,
            badges: []
        });

        alert("Usu√°rio cadastrado com sucesso!");
    } catch (error) {
        alert("Erro ao cadastrar: " + error.message);
    }
  }

  async function login(){
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value.trim();
    const email = username + "@showdown.com";
    
    try {
        await signInWithEmailAndPassword(auth, email, password);
    } catch (error) {
        alert("Usu√°rio ou senha incorretos! Detalhe: " + error.message);
    }
  }

  function logout(){
    signOut(auth);
  }

  async function showUserScreen(uid){
    currentUserId = uid;
    const userDocRef = doc(db, "users", uid);
    const userDoc = await getDoc(userDocRef);
    if (!userDoc.exists()) {
      console.error("Documento do usu√°rio n√£o encontrado.");
      return;
    }
    const user = userDoc.data();
    allUsersData[uid] = { uid, ...user };
    
    document.getElementById('user-display').innerText = user.username;
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('user-screen').classList.remove('hidden');
    
    if (user.isAdmin) {
      document.getElementById('admin-tab-btn').classList.remove('hidden');
    } else {
      document.getElementById('admin-tab-btn').classList.add('hidden');
    }
    await loadProfile();
    showTab('profile');
  }

  function showTab(tabName) {
    const tabs = document.querySelectorAll('.tab-content, #championship-details-view, #user-profile-details-view');
    tabs.forEach(tab => tab.classList.add('hidden'));

    const buttons = document.querySelectorAll('.tab-buttons button');
    buttons.forEach(btn => btn.classList.remove('active'));

    const currentTab = document.getElementById(tabName + '-tab');
    if (currentTab) {
      currentTab.classList.remove('hidden');
    }
    const activeTabBtn = document.querySelector(`.tab-buttons button[onclick="showTab('${tabName}')"]`);
    if (activeTabBtn) {
      activeTabBtn.classList.add('active');
    }

    previousTab = tabName;

    if (tabName === 'all-tournaments') loadAllChampionshipsList();
    else if (tabName === 'my-tournaments') loadMyChampionshipsList();
    else if (tabName === 'leaderboard') loadLeaderboard();
    else if (tabName === 'admin-panel') loadAdminPanel();
  }

  async function saveProfile(){
    if (!currentUserId) return;
    const name = document.getElementById('player-name').value.trim();
    const trainerImage = document.getElementById('player-image').value.trim();
    const bio = document.getElementById('bio-textarea').value.trim();
    const twitter = document.getElementById('twitter-input').value.trim();
    const discord = document.getElementById('discord-input').value.trim();
    
    const userDocRef = doc(db, "users", currentUserId);
    await updateDoc(userDocRef, {
      "profile.name": name,
      "profile.trainerImage": trainerImage,
      "profile.bio": bio,
      "profile.twitter": twitter,
      "profile.discord": discord
    });
    
    alert("Perfil salvo!");
    await loadProfile();
    toggleEditProfile(false);
  }

  async function toggleEditProfile(showEdit) {
    document.getElementById('profile-display-section').classList.toggle('hidden', showEdit);
    document.getElementById('profile-edit-section').classList.toggle('hidden', !showEdit);
    
    if (showEdit) {
        if (!currentUserId) return;
        const user = allUsersData[currentUserId];
        if (user) {
            document.getElementById('player-name').value = user.profile.name || '';
            document.getElementById('player-image').value = user.profile.trainerImage || '';
            document.getElementById('bio-textarea').value = user.profile.bio || '';
            document.getElementById('twitter-input').value = user.profile.twitter || '';
            document.getElementById('discord-input').value = user.profile.discord || '';
        }
    }
  }
  
  function goBackFromProfile() {
    showTab(previousTab);
  }

  async function loadProfile() {
    if (!currentUserId) return;
    const userDocRef = doc(db, "users", currentUserId);
    const userDoc = await getDoc(userDocRef);
    if (!userDoc.exists()) return;
    const user = userDoc.data();
    
    allUsersData[currentUserId] = { uid: currentUserId, ...user }; 
    
    document.getElementById('card-name').innerText = user.profile.name || 'Treinador';
    document.getElementById('card-image').src = user.profile.trainerImage || 'https://via.placeholder.com/120';
    document.getElementById('card-points').innerText = user.points || 0;
    document.getElementById('card-level').innerText = user.level || 1;
    
    const nextLevelPoints = LEVEL_THRESHOLDS[user.level + 1];
    const currentLevelPoints = LEVEL_THRESHOLDS[user.level] || 0;
    
    const progressBar = document.getElementById('level-progress-bar');
    if (nextLevelPoints !== undefined) {
      const progress = Math.min(100, Math.max(0, ((user.points - currentLevelPoints) / (nextLevelPoints - currentLevelPoints)) * 100));
      progressBar.style.width = progress + '%';
      progressBar.innerText = `${user.points} / ${nextLevelPoints} pts`;
    } else {
      progressBar.style.width = '100%';
      progressBar.innerText = `N√≠vel M√°ximo!`;
    }

    const socialsDiv = document.getElementById('profile-display-socials');
    socialsDiv.innerHTML = '';
    if (user.profile.twitter) {
        const twitterLink = document.createElement('a');
        twitterLink.href = user.profile.twitter.startsWith('http') ? user.profile.twitter : `https://twitter.com/${user.profile.twitter}`;
        twitterLink.target = '_blank';
        twitterLink.innerText = `Twitter`;
        socialsDiv.appendChild(twitterLink);
    }
    if (user.profile.discord) {
        const discordP = document.createElement('p');
        discordP.innerHTML = `Discord: <strong>${user.profile.discord}</strong>`;
        socialsDiv.appendChild(discordP);
    }
    
    const badgesContainer = document.getElementById('my-badges-list');
    badgesContainer.innerHTML = '';
    if(user.badges && user.badges.length > 0) {
        user.badges.forEach(badgeName => {
            const badgeDiv = document.createElement('div');
            badgeDiv.className = 'badge-item';
            badgeDiv.innerHTML = `üèÜ ${badgeName}`;
            badgesContainer.appendChild(badgeDiv);
        });
    }

    updatePokemonsCard(user.profile.pokemons);
  }

  function updatePokemonsCard(pokemons = []){
    const container = document.getElementById('card-pokemons-card');
    container.innerHTML = pokemons.map(p=>`
      <div class="pokemon-box">
        <img src="https://img.pokemondb.net/sprites/home/normal/${p.toLowerCase()}.png" alt="${p}">
        <button class="remove-btn" onclick="removePokemon('${p}')">√ó</button>
      </div>
    `).join('');
  }

  async function createChampionship(){
    const user = allUsersData[currentUserId];
    if(!user) return;

    const name=document.getElementById('championship-name').value.trim();
    const rules=document.getElementById('championship-rules').value.trim();
    const date=document.getElementById('championship-date').value;
    const max=parseInt(document.getElementById('championship-max').value);
    if(!name||!rules||!date||!max){alert("Preencha todos os campos!");return;}
    
    const championship={
      name, rules, date, max,
      players: [currentUserId],
      owner: currentUserId,
      rounds:[], status: 'Open', 
      isGym: user.isAdmin
    };
    
    await addDoc(collection(db, "championships"), championship);
    
    alert("Campeonato criado!");
    showTab('all-tournaments');
  }

  async function joinChampionship(champId){
    if(!currentUserId) return;
    
    const joinBtn = document.getElementById('join-btn');
    joinBtn.disabled = true;
    joinBtn.innerText = 'Entrando...';

    const champDocRef = doc(db, 'championships', champId);
    
    try {
        const champDoc = await getDoc(champDocRef);
        if (!champDoc.exists()) {
            alert("Erro: Campeonato n√£o encontrado.");
            joinBtn.disabled = false;
            joinBtn.innerText = 'Entrar';
            return;
        }

        const c = champDoc.data();

        if(c.players.includes(currentUserId)){
            alert("Voc√™ j√° est√° nesse campeonato!");
            await showChampionshipDetails(champId);
            return;
        }
        if(c.players.length >= c.max){
            alert("Campeonato cheio!");
            await showChampionshipDetails(champId);
            return;
        }
        if(c.status !== 'Open'){
            alert("Este campeonato n√£o est√° aberto para inscri√ß√µes!");
            await showChampionshipDetails(champId);
            return;
        }
        
        await updateDoc(champDocRef, {
            players: arrayUnion(currentUserId)
        });

        await showChampionshipDetails(champId);

    } catch (error) {
        console.error("Erro ao entrar no campeonato:", error);
        alert("Ocorreu um erro ao tentar entrar no campeonato.");
        joinBtn.disabled = false;
        joinBtn.innerText = 'Entrar';
    }
  }

  async function drawBracket(champId){
    const bracketBtn = document.getElementById('bracket-btn');
    bracketBtn.disabled = true;
    bracketBtn.innerText = 'Sorteando...';

    try {
      const champDocRef = doc(db, 'championships', champId);
      const champDoc = await getDoc(champDocRef);
      if (!champDoc.exists()) throw new Error("Campeonato n√£o encontrado.");

      const c = champDoc.data();
      
      const user = allUsersData[currentUserId];
      if (c.owner !== currentUserId && !user.isAdmin) {
        alert("Apenas o criador ou um administrador pode sortear!");
        return;
      }
      
      if(c.rounds.length > 0){
        alert("O chaveamento j√° foi sorteado.");
        return;
      }
      
      let players=[...c.players];
      if(players.length < 2){
        alert("S√£o necess√°rios no m√≠nimo 2 jogadores para o sorteio!");
        return;
      }

      players.sort(()=>Math.random()-0.5);
      let firstRoundMatches=[];
      while(players.length>=2){
        firstRoundMatches.push({p1:players.pop(), p2:players.pop(), winner:null, replayLink: null});
      }
      if(players.length===1){
        const luckyPlayer = players.pop();
        firstRoundMatches.push({p1: luckyPlayer, p2: 'BYE', winner: luckyPlayer, replayLink: null});
      }
      
      const firstRoundObject = { matches: firstRoundMatches };
      
      await updateDoc(champDocRef, {
        rounds: [firstRoundObject],
        status: 'In Progress'
      });
      
      await showChampionshipDetails(champId);
    } catch (error) {
      console.error("Erro ao sortear chaveamento:", error);
      alert("Ocorreu um erro ao sortear o chaveamento: " + error.message);
    } finally {
      bracketBtn.disabled = false;
      bracketBtn.innerText = 'Sortear Chaveamento';
    }
  }

  async function setWinner(champId, roundIndex, battleIndex, winnerUid, replayLink){
    try {
        const champDocRef = doc(db, 'championships', champId);
        const champDoc = await getDoc(champDocRef);
        const champ = champDoc.data();
        
        let battle = champ.rounds[roundIndex].matches[battleIndex];
        
        battle.winner = winnerUid;
        battle.replayLink = replayLink || null;
        
        const winnerUserDocRef = doc(db, 'users', winnerUid);

        if (!champ.isGym) {
            await updateDoc(winnerUserDocRef, { points: increment(10) });
            await checkLevelUp(winnerUid);
        }
        
        if(champ.rounds[roundIndex].matches.every(b => b.winner)){
          let winners = champ.rounds[roundIndex].matches.map(b => b.winner);
          if(winners.length > 1){
            let nextRoundMatches = [];
            while(winners.length >= 2){
              nextRoundMatches.push({p1: winners.shift(), p2: winners.shift(), winner: null, replayLink: null});
            }
            if (winners.length === 1) {
              const luckyPlayer = winners.shift();
              nextRoundMatches.push({p1: luckyPlayer, p2: 'BYE', winner: luckyPlayer, replayLink: null});
            }
            champ.rounds.push({ matches: nextRoundMatches });
          } else {
            champ.status = 'Finished';
            const finalWinner = winners[0];
            
            if (!champ.isGym) {
              await updateDoc(doc(db, "users", finalWinner), { points: increment(50) });
            }
            alert(`O torneio ${champ.name} foi finalizado! O campe√£o √©: ${allUsersData[finalWinner]?.profile.name || allUsersData[finalWinner]?.username}`);
          }
        }

        await updateDoc(champDocRef, { rounds: champ.rounds, status: champ.status });
        await loadAllUsersData(); 
        await showChampionshipDetails(champId);
        hideWinnerModal();
    } catch (error) {
        console.error("Erro ao definir vencedor:", error);
        alert("Ocorreu um erro ao definir o vencedor: " + error.message);
    }
  }

  function showWinnerModal(champId, roundIndex, battleIndex, winnerUid) {
    currentWinnerChampId = champId;
    currentWinnerRound = roundIndex;
    currentWinnerBattle = battleIndex;
    currentWinnerUid = winnerUid;

    const winnerName = allUsersData[winnerUid]?.profile.name || allUsersData[winnerUid]?.username;
    document.getElementById('modal-title').innerText = `Confirmar vit√≥ria de ${winnerName}`;
    
    document.getElementById('winner-modal').classList.remove('hidden');
  }

  function hideWinnerModal() {
    document.getElementById('winner-modal').classList.add('hidden');
    document.getElementById('replay-link').value = '';
  }

  function confirmWinner() {
    const replayLink = document.getElementById('replay-link').value;
    setWinner(currentWinnerChampId, currentWinnerRound, currentWinnerBattle, currentWinnerUid, replayLink);
  }

  async function checkLevelUp(uid){
    const userDocRef = doc(db, "users", uid);
    const userDoc = await getDoc(userDocRef);
    const user = userDoc.data();
    
    let currentLevel = user.level || 1;
    let nextLevel = currentLevel + 1;
    
    while(LEVEL_THRESHOLDS[nextLevel] !== undefined && user.points >= LEVEL_THRESHOLDS[nextLevel]){
        currentLevel++;
        nextLevel++;
    }
    
    if (currentLevel > user.level) {
        await updateDoc(userDocRef, { level: currentLevel });
        alert(`Parab√©ns, ${user.profile.name || user.username}! Voc√™ subiu para o N√≠vel ${currentLevel}!`);
    }
  }

  async function deleteChampionship(champId){
    const user = allUsersData[currentUserId];
    const champDocRef = doc(db, 'championships', champId);
    const champDoc = await getDoc(champDocRef);
    const champ = champDoc.data();

    if(currentUserId !== champ.owner && !(user && user.isAdmin)){
      alert("Apenas o criador ou um administrador pode excluir!");
      return;
    }
    
    if (confirm(`Tem certeza que deseja excluir o campeonato ${champ.name}?`)) {
        await deleteDoc(champDocRef);
        alert(`Campeonato ${champ.name} exclu√≠do.`);
        showTab('all-tournaments');
    }
  }
  
  function showChampionshipsList(listElement, championships) {
    listElement.innerHTML = '';
    if (championships.length === 0) {
      listElement.innerHTML = '<p>Nenhum torneio encontrado.</p>';
      return;
    }
    championships.forEach(c => {
      let li = document.createElement('div');
      li.className = `champ-list-card ${c.isGym ? 'gym-tournament' : ''}`;
      li.innerHTML = `
        <h4>${c.name} <span class="status ${c.status.toLowerCase()}">${c.status}</span></h4>
        <p>Criador: ${allUsersData[c.owner]?.profile.name || allUsersData[c.owner]?.username || 'Desconhecido'}</p>
        <p>Jogadores: ${c.players.length}/${c.max}</p>
      `;
      li.onclick = () => showChampionshipDetails(c.id);
      listElement.appendChild(li);
    });
  }

  async function loadAllChampionshipsList(){
    const q = query(collection(db, "championships"));
    const querySnapshot = await getDocs(q);
    
    let allChampionships = [];
    querySnapshot.forEach(doc => {
      allChampionships.push({ id: doc.id, ...doc.data() });
    });

    const gymTournamentsActive = allChampionships.filter(c => c.isGym && (c.status === 'Open' || c.status === 'In Progress'));
    const activeTournaments = allChampionships.filter(c => !c.isGym && (c.status === 'Open' || c.status === 'In Progress'));
    const gymTournamentsFinished = allChampionships.filter(c => c.isGym && c.status === 'Finished');
    const finishedTournaments = allChampionships.filter(c => !c.isGym && c.status === 'Finished');

    showChampionshipsList(document.getElementById('all-championships-list-gym-active'), gymTournamentsActive);
    showChampionshipsList(document.getElementById('all-championships-list-active'), activeTournaments);
    showChampionshipsList(document.getElementById('all-championships-list-gym-finished'), gymTournamentsFinished);
    showChampionshipsList(document.getElementById('all-championships-list-finished'), finishedTournaments);
  }

  async function loadMyChampionshipsList(){
    if(!currentUserId) return;
    const q = query(collection(db, "championships"), where("players", "array-contains", currentUserId));
    const querySnapshot = await getDocs(q);
    
    let myChampionships = [];
    querySnapshot.forEach(doc => {
      myChampionships.push({ id: doc.id, ...doc.data() });
    });

    let activeList = document.getElementById('my-championships-list-active');
    let finishedList = document.getElementById('my-championships-list-finished');
    
    const activeChamps = myChampionships.filter(c => c.status === 'Open' || c.status === 'In Progress');
    const finishedChamps = myChampionships.filter(c => c.status === 'Finished');

    showChampionshipsList(activeList, activeChamps);
    showChampionshipsList(finishedList, finishedChamps);
  }
  
  async function loadLeaderboard(){
    const q = query(collection(db, "users"));
    const querySnapshot = await getDocs(q);
    
    let allPlayers = [];
    querySnapshot.forEach(doc => {
      const data = doc.data();
      allPlayers.push({
        uid: doc.id,
        username: data.username,
        points: data.points || 0,
        level: data.level || 1,
        profileName: data.profile.name
      });
    });

    allPlayers.sort((a, b) => {
      if (b.points !== a.points) return b.points - a.points;
      return b.level - a.level;
    });

    let rankingList = document.getElementById('ranking-list');
    rankingList.innerHTML = '';
    
    allPlayers.slice(0, 10).forEach((player, index) => {
      let li = document.createElement('li');
      li.innerHTML = `<strong>${index + 1}.</strong> <span class="player-name-link" onclick="showUserProfileDetails('${player.uid}')">${player.profileName || player.username}</span> <span>(N√≠vel ${player.level} - ${player.points} pontos)</span>`;
      rankingList.appendChild(li);
    });
  }

  async function showChampionshipDetails(champId){
    const views = document.querySelectorAll('.tab-content, #user-profile-details-view');
    views.forEach(view => view.classList.add('hidden'));
    document.getElementById('championship-details-view').classList.remove('hidden');

    const champDoc = await getDoc(doc(db, "championships", champId));
    if(!champDoc.exists()) return;

    const champ = champDoc.data();

    document.getElementById('champ-details-name').innerText = champ.name;
    document.getElementById('champ-details-status').innerText = champ.status;
    document.getElementById('champ-details-owner').innerText = allUsersData[champ.owner]?.profile.name || allUsersData[champ.owner]?.username || 'Desconhecido';
    document.getElementById('champ-details-date').innerText = champ.date;
    document.getElementById('champ-details-rules').innerText = champ.rules;
    document.getElementById('champ-details-players').innerText = champ.players.map(uid => allUsersData[uid]?.profile.name || allUsersData[uid]?.username).join(', ');
    document.getElementById('champ-details-count').innerText = champ.players.length;
    document.getElementById('champ-details-max').innerText = champ.max;

    const user = allUsersData[currentUserId];
    const isOwner = currentUserId === champ.owner;
    const isAdmin = user && user.isAdmin;
    const isPlayer = champ.players.includes(currentUserId);

    const joinBtn = document.getElementById('join-btn');
    const bracketBtn = document.getElementById('bracket-btn');
    const deleteBtn = document.getElementById('delete-btn');
    
    joinBtn.disabled = false;
    joinBtn.innerText = 'Entrar';

    joinBtn.classList.add('hidden');
    bracketBtn.classList.add('hidden');
    deleteBtn.classList.add('hidden');

    if(isOwner || isAdmin){
      if (champ.status === 'Open') {
        bracketBtn.classList.remove('hidden');
        bracketBtn.onclick = () => drawBracket(champId);
      }
      deleteBtn.classList.remove('hidden');
      deleteBtn.onclick = () => deleteChampionship(champId);
    } else if (!isPlayer && champ.status === 'Open') {
      joinBtn.classList.remove('hidden');
      joinBtn.onclick = () => joinChampionship(champId);
    }

    const bracketContainer = document.getElementById('championship-bracket-container');
    bracketContainer.innerHTML = '';

    if(champ.rounds && champ.rounds.length > 0){
      let bracketDiv = document.createElement('div');
      bracketDiv.className = "bracket-container";
      bracketDiv.innerHTML = `<h3 class="bracket-heading">Chaveamento</h3>`;

      let roundsDiv = document.createElement('div');
      roundsDiv.className = "bracket-rounds";

      champ.rounds.forEach((round, i) => {
        let roundDiv = document.createElement('div');
        roundDiv.className = "bracket-round";
        
        let numBattles = round.matches.length;
        let roundTitle = "";
        if (numBattles > 4) roundTitle = `Rodada ${i + 1}`;
        else if (numBattles === 4) roundTitle = "Quartas de Final";
        else if (numBattles === 2) roundTitle = "Semifinais";
        else if (numBattles === 1) roundTitle = "Final";

        roundDiv.innerHTML = `<h4 class="round-heading">${roundTitle}</h4>`;

        round.matches.forEach((b, idx) => {
          let matchupDiv = document.createElement('div');
          matchupDiv.className = "bracket-matchup";
          
          const canSetWinner = !b.winner && (currentUserId === champ.owner || currentUserId === b.p1 || currentUserId === b.p2);
          const player1Name = allUsersData[b.p1]?.profile.name || allUsersData[b.p1]?.username;
          const player2Name = b.p2 === 'BYE' ? 'BYE' : (allUsersData[b.p2]?.profile.name || allUsersData[b.p2]?.username);

          let replayHtml = b.replayLink ? ` <a href="${b.replayLink}" target="_blank">(Replay)</a>` : '';
          matchupDiv.innerHTML = `
            <div class="bracket-player ${b.winner === b.p1 ? 'is-winner' : (b.winner && b.winner !== b.p1) ? 'is-loser' : ''}">
              <span class="player-name-link" onclick="showUserProfileDetails('${b.p1}')">${player1Name}</span>
              ${canSetWinner ? `<span class="player-btn" onclick="showWinnerModal('${champId}',${i},${idx},'${b.p1}')">Vence</span>` : ''}
              ${b.winner === b.p1 ? replayHtml : ''}
            </div>
            ${ b.p2 !== 'BYE' ? `
            <div class="bracket-player ${b.winner === b.p2 ? 'is-winner' : (b.winner && b.winner !== b.p2) ? 'is-loser' : ''}">
              <span class="player-name-link" onclick="showUserProfileDetails('${b.p2}')">${player2Name}</span>
              ${canSetWinner ? `<span class="player-btn" onclick="showWinnerModal('${champId}',${i},${idx},'${b.p2}')">Vence</span>` : ''}
              ${b.winner === b.p2 ? replayHtml : ''}
            </div>` : ''}
          `;
          roundDiv.appendChild(matchupDiv);
        });
        roundsDiv.appendChild(roundDiv);
      });
      bracketDiv.appendChild(roundsDiv);
      bracketContainer.appendChild(bracketDiv);
    }
  }

  function goBackToList(){
    showTab('all-tournaments');
  }

  async function loadAllUsersData() {
    const q = query(collection(db, "users"));
    const querySnapshot = await getDocs(q);
    allUsersData = {};
    querySnapshot.forEach(doc => {
        allUsersData[doc.id] = { uid: doc.id, ...doc.data() };
    });
  }

  // --- Fun√ß√µes do Painel Admin e Busca de Usu√°rio ---

  async function loadAdminPanel() {
    const user = allUsersData[currentUserId];
    const userListDiv = document.getElementById('user-list-admin');
    userListDiv.innerHTML = '';
    
    if (user && user.isAdmin) {
        Object.values(allUsersData).forEach(userData => {
            if (userData.uid !== currentUserId) {
                let userCard = document.createElement('div');
                userCard.className = "champ-list-card";
                userCard.innerHTML = `
                    <h4>${userData.profile.name || userData.username}</h4>
                    <p>Usu√°rio: ${userData.username}</p>
                    <p>N√≠vel: ${userData.level || 1} | Pontos: ${userData.points || 0}</p>
                    <button onclick="banUser('${userData.uid}')">Excluir Usu√°rio</button>
                `;
                userListDiv.appendChild(userCard);
            }
        });
    } else {
        userListDiv.innerHTML = '<p>Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</p>';
    }
  }

  async function banUser(uidToBan) {
      if (confirm(`Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.`)) {
          await deleteDoc(doc(db, "users", uidToBan));
          alert(`Usu√°rio exclu√≠do do banco de dados.`);
          delete allUsersData[uidToBan];
          loadAdminPanel();
      }
  }
  
  const userSearchInput = document.getElementById('user-search-input');
  const searchResultsDiv = document.getElementById('search-results-list');
  userSearchInput.addEventListener('input', function(){
    const query = this.value.toLowerCase();
    searchResultsDiv.innerHTML = '';
    if (query.length < 2) return;
    
    const matches = Object.values(allUsersData).filter(user =>
      user.username.toLowerCase().includes(query) || (user.profile.name && user.profile.name.toLowerCase().includes(query))
    );

    matches.forEach(user => {
      const resultItem = document.createElement('div');
      resultItem.className = "search-result-item";
      resultItem.innerHTML = `<span>${user.profile.name || user.username}</span> <span>(N√≠vel ${user.level || 1})</span>`;
      resultItem.onclick = () => showUserProfileDetails(user.uid);
      searchResultsDiv.appendChild(resultItem);
    });
  });

  async function showUserProfileDetails(uid) {
    const user = allUsersData[uid];
    if (!user) {
        console.error("Usu√°rio n√£o encontrado no cache.");
        return;
    }
    const tabs = document.querySelectorAll('.tab-content, #championship-details-view');
    tabs.forEach(tab => tab.classList.add('hidden'));
    document.getElementById('user-profile-details-view').classList.remove('hidden');

    document.getElementById('other-user-card-name').innerText = user.profile.name || user.username;
    document.getElementById('other-user-card-image').src = user.profile.trainerImage || 'https://via.placeholder.com/120';
    document.getElementById('other-user-card-level').innerText = user.level || 1;
    document.getElementById('other-user-card-points').innerText = user.points || 0;
    document.getElementById('other-user-bio').innerText = user.profile.bio || 'Nenhuma biografia.';
    
    const socialsDiv = document.getElementById('other-user-socials');
    socialsDiv.innerHTML = '';
    if (user.profile.twitter) {
        const twitterLink = document.createElement('a');
        twitterLink.href = user.profile.twitter.startsWith('http') ? user.profile.twitter : `https://twitter.com/${user.profile.twitter}`;
        twitterLink.target = '_blank';
        twitterLink.innerText = `Twitter`;
        socialsDiv.appendChild(twitterLink);
    }
    if (user.profile.discord) {
        const discordP = document.createElement('p');
        discordP.innerHTML = `Discord: <strong>${user.profile.discord}</strong>`;
        socialsDiv.appendChild(discordP);
    }

    const pokemonsContainer = document.getElementById('other-user-card-pokemons');
    pokemonsContainer.innerHTML = (user.profile.pokemons || []).map(p=>`
        <div class="pokemon-box">
            <img src="https://img.pokemondb.net/sprites/home/normal/${p.toLowerCase()}.png" alt="${p}">
        </div>
    `).join('');
    
    const badgesContainer = document.getElementById('other-badges-list');
    badgesContainer.innerHTML = '';
    if(user.badges && user.badges.length > 0) {
        user.badges.forEach(badgeName => {
            const badgeDiv = document.createElement('div');
            badgeDiv.className = 'badge-item';
            badgeDiv.innerHTML = `üèÜ ${badgeName}`;
            badgesContainer.appendChild(badgeDiv);
        });
    }
  }

  // --- INICIALIZA√á√ÉO ---
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      await loadAllUsersData();
      await showUserScreen(user.uid);
    } else {
      currentUserId = null;
      allUsersData = {};
      document.getElementById('user-screen').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
    }
  });

  loadAllPokemons();

  // EXPOR FUN√á√ïES PARA O ESCOPO GLOBAL (window)
  window.login = login;
  window.signup = signup;
  window.logout = logout;
  window.showTab = showTab;
  window.toggleEditProfile = toggleEditProfile;
  window.saveProfile = saveProfile;
  window.addPokemon = addPokemon;
  window.removePokemon = removePokemon;
  window.createChampionship = createChampionship;
  window.joinChampionship = joinChampionship;
  window.drawBracket = drawBracket;
  window.showWinnerModal = showWinnerModal;
  window.hideWinnerModal = hideWinnerModal;
  window.confirmWinner = confirmWinner;
  window.deleteChampionship = deleteChampionship;
  window.banUser = banUser;
  window.showChampionshipDetails = showChampionshipDetails;
  window.goBackToList = goBackToList;
  window.showUserProfileDetails = showUserProfileDetails;
  window.goBackFromProfile = goBackFromProfile;
</script>
</body>
</html>